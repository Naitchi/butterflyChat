<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <link rel="stylesheet" href="./styles/chatRoom.css" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap');
    </style>
  </head>

  <body>
    <h1 class="title"><a href="/">Butterfly Chat</a></h1>
    <button id="copy">→ Copier le lien d'invitation ←</button>
    <!-- TODO faire une animation soit les trois petits points soit un cercle qui tourne -->
    <p id="box_loading">Chargement du salon de discussion...</p>
    <div id="box_username" class="hide">
      <label for="username" class="label_username">
        Pour rentrer dans la discussion il vous faut un nom d'utilisateur:
      </label>
      <input placeholder="Votre pseudo" type="text" name="unsername" id="username" />
      <button id="validation">Validé</button>
    </div>
    <!-- TODO ajouté une listes des users si c'est possible -->
    <div id="box_chat" class="hide">
      <ul id="messages"></ul>
      <form id="form" action="">
        <input id="input" autocomplete="off" />
        <button id="send">Envoyer</button>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://js.pusher.com/8.0.1/pusher.min.js"></script>
    <script>
      // Config Pusher
      Pusher.logToConsole = true;
      const pusher = new Pusher('46c45f5e0f237306de38', {
        cluster: 'eu',
        forceTLS: true,
      });

      // https://butterfly-chat.vercel.app
      // http://localhost:3000
      const link = 'https://butterfly-chat.vercel.app';

      // Récupérer les éléments du DOM
      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const messages = document.getElementById('messages');
      const usernameInput = document.getElementById('username');
      const validation = document.getElementById('validation');
      const usernameBox = document.getElementById('box_username');
      const chatBox = document.getElementById('box_chat');
      const loadingBox = document.getElementById('box_loading');
      const copy = document.getElementById('copy');
      let username = '';
      username = localStorage.getItem('username');

      // Fonction pour extraire l'ID de l'URL
      const urlParams = new URLSearchParams(window.location.search);
      const idRoom = urlParams.get('room');
      let channel = null;
      if (idRoom) {
        channel = pusher.subscribe(`butterflychat-${idRoom}`);
        console.log('Salon trouvé');
      } else alert('Aucun id trouvé dans l"url');

      pusher.connection.bind('connected', () => {
        checkUsername(username, usernameBox, chatBox, loadingBox);
      });

      // Handle received messages
      channel.bind('message', (data) => {
        const box = document.createElement('div');
        box.classList.add('box_message');
        const user = document.createElement('p');
        user.classList.add('username');
        user.textContent = `${data.username}:`;
        const item = document.createElement('p');
        item.classList.add('text');
        item.textContent = data.msg;
        if (data.username === username) {
          box.classList.add('our_message');
        } else {
          box.appendChild(user);
        }
        box.appendChild(item);
        messages.appendChild(box);
        messages.scrollTop = 9999999;
      });

      // Handle new chatters
      channel.bind('newChatter', (data) => {
        const item = document.createElement('p');
        item.classList.add('connexion');
        item.textContent = `L'utilisateur ${data.username} vient de se connecter au salon.`;
        messages.appendChild(item);
        messages.scrollTop = 9999999;
      });

      const checkUsername = async (username, divUser, divChat, divLoading) => {
        console.log('checkUsername');
        if (!divLoading.classList.contains('hide')) divLoading.classList.add('hide');

        if (!username || !username.trim()) {
          usernameBox.classList.remove('hide');
          return;
        } else usernameBox.classList.add('hide');
        chatBox.classList.remove('hide');

        console.log('in newChatter');
        try {
          const payload = {
            username: username,
            idRoom: idRoom,
          };
          console.log(payload);
          await axios.post(`${link}/api/newChatter`, payload);
          console.log('newChatter connected');
        } catch (error) {
          console.error('Error sending message:', error);
        }
      };

      validation.addEventListener('click', () => {
        if (usernameInput.value.trim().length > 0) {
          localStorage.setItem('username', usernameInput.value.trim());
          username = usernameInput.value.trim();
          checkUsername(username, usernameBox, chatBox, loadingBox);
        }
      });

      window.addEventListener('beforeunload', async () => {
        console.log('in newChatter');
        if (!username.trim()) return;
        try {
          const payload = {
            username: username,
            idRoom: idRoom,
          };
          console.log(payload);
          await axios.post(`${link}/api/chatterLeft`, payload);
          console.log('Chatter left successfully');
        } catch (error) {
          console.error('Error sending message:', error);
        }
      });

      channel.bind('chatterLeft', (data) => {
        const item = document.createElement('p');
        item.classList.add('connexion');
        item.textContent = `L'utilisateur ${data.username} vient de se déconnecter au salon.`;
        messages.appendChild(item);
        messages.scrollTop = 9999999;
      });

      copy.addEventListener('click', () => {
        navigator.clipboard.writeText(window.location.href);
        copy.innerText = 'Lien copié !';
        setInterval(() => {
          copy.innerText = "→ Copier le lien d'invitation ←";
        }, 700);
      });

      // Handle form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('in submit');
        if (!input.value.trim()) {
          return;
        }
        try {
          const payload = {
            username: username,
            msg: input.value,
            idRoom: idRoom,
          };
          input.value = '';
          console.log(payload);
          await axios.post(`${link}/api/`, payload);
          console.log('submit done');
        } catch (error) {
          console.error('Error sending message:', error);
        }
      });
    </script>
  </body>
</html>
