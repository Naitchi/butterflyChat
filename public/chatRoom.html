<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <link rel="stylesheet" href="./styles/chatRoom.css" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap');
    </style>
  </head>

  <body>
    <h1 class="title"><a href="/">Butterfly Chat</a></h1>
    <!-- TODO faire un bouton pour copier le lien en un clique -->
    <div id="box_username">
      <label for="username" class="label_username">
        Pour rentrer dans la discussion il vous faut un nom d'utilisateur:
      </label>
      <input placeholder="Votre pseudo" type="text" name="unsername" id="username" />
      <button id="validation">Validé</button>
    </div>
    <!-- TODO ajouté une listes des users si c'est possible -->
    <div id="box_chat" class="hide">
      <ul id="messages">
        <!-- TODO faire un message de connexion <p>Vous êtes connecté</p> -->
      </ul>
      <form id="form" action="">
        <input id="input" autocomplete="off" />
        <button id="send">Envoyer</button>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://js.pusher.com/8.0.1/pusher.min.js"></script>
    <script>
      // Config Pusher
      Pusher.logToConsole = true;
      const pusher = new Pusher('46c45f5e0f237306de38', {
        cluster: 'eu',
        forceTLS: true,
      });

      // Récupérer les éléments du DOM
      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const messages = document.getElementById('messages');
      const usernameInput = document.getElementById('username');
      const validation = document.getElementById('validation');
      const usernameBox = document.getElementById('box_username');
      const chatBox = document.getElementById('box_chat');

      const checkUsername = (username, divUser, divChat) => {
        console.log('checkUsername');
        if (username !== null) {
          usernameBox.classList.add('hide');
          chatBox.classList.remove('hide');
        }
      };

      // Fonction pour extraire l'ID de l'URL
      const urlParams = new URLSearchParams(window.location.search);
      const idRoom = urlParams.get('room');
      let channel = null;
      if (idRoom) {
        channel = pusher.subscribe(`butterflychat-${idRoom}`);
        console.log('Salon trouvé');
      } else alert('Aucun id trouvé dans l"url');

      let username = localStorage.getItem('username');
      checkUsername(username, usernameBox, chatBox);

      validation.addEventListener('click', () => {
        if (usernameInput.value.length > 0) {
          localStorage.setItem('username', usernameInput.value);
          username = usernameInput.value;
          checkUsername(username, usernameBox, chatBox);
        }
      });

      // Handle form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('in submit');
        if (!input.value.trim()) {
          return;
        }
        try {
          const payload = {
            username: username,
            msg: input.value,
            idRoom: idRoom,
          };
          console.log(payload);
          // https://butterfly-chat.vercel.app
          // http://localhost:3000
          await axios.post('https://butterfly-chat.vercel.app/api/', payload);
          input.value = '';
          console.log('submit done');
        } catch (error) {
          console.error('Error sending message:', error);
        }
      });

      // Handle received messages
      channel.bind('message', (data) => {
        const box = document.createElement('div');
        box.classList.add('box_message');
        const user = document.createElement('p');
        user.classList.add('username');
        user.textContent = `${data.username}:`;
        const item = document.createElement('p');
        item.classList.add('text');
        item.textContent = data.msg;
        if (data.username === username) {
          box.classList.add('our_message');
        } else {
          box.appendChild(user);
        }
        box.appendChild(item);
        messages.appendChild(box);
        window.scrollTo(0, document.body.scrollHeight);
      });
    </script>
  </body>
</html>
